# Проект ExploreWithMe
[Ссылка на pull request (основной функционал)](https://github.com/pavalka/explore-with-me/pull/2)

[Описание дополнительного функционала](#дополнительная-функциональность-комментарии)

Данный репозиторий содержит учебный проект ExplorerWithMe, который представляет собой бекэнд сервиса, позволяющего 
пользователям делиться информацией об интересных событиях и искать компанию для участия в них.
Ниже кратко описывается структура данного приложения:
- структура сущностей
- структура базы данных
- структура приложения (схема взаимодействия сервисов, контроллеров, репозиториев и т. д.)

Приложение состоит из двух сервисов: основного сервиса (main service) и сервиса статистики (statistics service). Исходя 
из этого, каждая схема разбита на две части, которые описывают соответствующие сервисы.

## Структура приложения
### Структура сущностей
На рисунке ниже приведены классы, которые описывают модель данных данного приложения. Стрелками отображены зависимости 
классов друг от друга.
![Структура сущностей](doc/classes_diagram.png)

В секции **Main service classes** находятся классы, относящиеся к главному сервису приложения, а в секции **Statistics
service classes** - к сервису статистики.

### Структура БД
На рисунке ниже приведена ER-диаграмма БД приложения.
![ER-диаграмма БД](doc/er-diagram.png)

Здесь так же, как и в предыдущем разделе таблицы разбиты на две части:
1. **Main service DB** - таблицы БД основного сервиса.
   
   - `requests` - таблица, которая хранит запросы пользователей на участие в различных событиях;
   - `categories` - таблица, которая хранит категории событий;
   - `users` - таблица, которая хранит информацию о пользователях сервиса;
   - `events` - таблица, хранящая данных о событиях;
   - `compilations` - таблица, которая хранит информацию о подборках событий;
   - `events_compilations` - таблица, которая задает связь между событиями и подборками событий;
   - `comments` - таблица, хранящая комментарии пользователей;

2. **Statistics service DB** - таблица базы данных сервиса статистики.

### Структура приложения
Структура приложения представлена на рисунке ниже.
![Структура приложения](doc/project_structure.png)

Здесь стоит отметить, что классы бизнес-логики `XxxServiceImpl` могут реализовывать два интерфейса: `XxxService` и 
`ThirdPartXxxService`. Здесь `Xxx` обозначает сущность, за логику работы с которой, отвечает данный класс. Например, 
за логику обработки сущности `User` отвечает класс `UserServiceImpl`. 
Интерфейс `XxxService` описывает функционал, предоставляемый классом `XxxServiceImpl` REST-контроллерам приложения. А 
интерфейс `ThirdPartXxxService`, в свою очередь, описывает функционал, предоставляемый другим классам `XxxServiceImpl`.
Например, как показано на схеме выше, класс `UserServiceImpl` предоставляет свой функционал классам `EventServiceImpl`, 
`RequestServiceImpl` и `CommentServiceImpl`.
Взаимодействие основного сервиса с сервисом статистики осуществляется через `StatisticsClient`.

## Дополнительная функциональность Комментарии

В качестве дополнительной функциональности была выбрана функциональность "Комментарии". Данная функциональность позволяет 
пользователям, участвовавшим в тех или иных событиях, оставлять комментарии к этим событиям, редактировать их, 
а также удалять свои комментарии. Также в рамках данной функциональности реализована возможность проводить модерацию 
комментариев пользователей. 

Комментарий к событию может оставить только пользователь, который принимал участие в данном событии, и только если после 
начала события прошло не менее одного часа. Далее комментарий проходит модерацию администратором, и только если он
одобрит этот комментарий (статус комментария - `MODERATED`), то этот комментарий становится виден остальным 
пользователям. Также администратор может отклонить комментарий (статус `REJECTED`). В этом случае он остается 
недоступным другим пользователям, кроме автора. Пока комментарий не проверен администратором автор может отредактировать 
его. После проверки редактирование комментария невозможно. Автор комментария может удалить его, при этом данный 
комментарий помечается как `DELETED`, и становится недоступным ни для автора, ни для других пользователей кроме 
администратора. Только администратор может полностью удалить комментарий из базы.  

Доступ к отдельным функциям осуществляется через набор эндпоинтов. Ниже приводится их описание.

Код бизнес-логики, репозитория, классов сущностей и DTO находится в пакете `comments`. Код REST-контроллеров распределен 
по нескольким пакетам: `admin`, `comments`, `events`, `users`. 

### Функции администрирования 

   - `PATCH /admin/comments/{comId}/moderate` - помечает комментарий как прошедший проверку администратором. При этом 
   фиксируется дата и время этого события.
   - `PATCH /admin/comments/{comId}/reject` - помечает комментарий как отклоненный (не прошедший модерацию) 
   администратором. Также фиксируется дата и время этого события.
   - `GET /admin/comments` - позволяет получить список комментариев, удовлетворяющих заданным критериям. Эти критерии 
   передаются в виде параметров запроса. Доступны следующие параметры:
     - `events` - список идентификаторов событий, комментарии к которым нужно получить. Необязательный параметр.
     - `authors` - список идентификаторов пользователей, комментарии которых нужно получить. Необязательный параметр.
     - `statuses` - список статусов комментариев, которые нужно получить. Необязательный параметр.
     - `edited` - если данное поле равно `true`, то параметры `rangeStart` и `rangeEnd` задают условия для поиска по 
     дате и времени редактирования комментария. Если же этот параметр равен `false`, то `rangeStart` и `rangeEnd` задают 
     условия по дате и времени создания комментария. Значение по-умолчанию - `false`. 
     - `rangeStart` - дата и время начала временного интервала, за который будут искаться комментарии.
     - `rangeEnd` - дата и время окончания временного интервала, за который будут искаться комментарии.
     - `from` - количество комментариев, которые нужно пропустить при создании данного списка комментариев. Значение 
     по-умолчанию - 0.
     - `size` - количество комментариев, которые нужно вернуть. Значение по-умолчанию - 10.
   - `GET /admin/comments/{comId}` - возвращает комментарий с идентификатором `comId`.
   - `DELETE /admin/comments` - позволяет удалить все комментарии помеченные как `DELETED`.
   - `DELETE /admin/comments/{comId}` - позволяет удалить комментарий с идентификатором `comId`.

### Общедоступные функции

  - `GET /comments/{comId}` - позволяет получить комментарий, прошедший модерацию, по его идентификатору.
  - `GET /events/{eventId}/comments` - позволяет получить список комментариев, прошедших модерацию для события с 
  идентификатором `eventId`. В этом запросе может быть два параметра:
    - `from` - количество комментариев, которые нужно пропустить при создании данного списка комментариев. Значение
      по-умолчанию - 0.
    - `size` - количество комментариев, которые нужно вернуть. Значение по-умолчанию - 10.

### Функции для зарегистрированных пользователей

  - `POST /users/{userId}/comments` - позволяет пользователю с идентификатором `userId` создать комментарий к событию, 
  которое указано в теле запроса.
  - `PATCH /users/{userId}/comments/{comId}` - позволяет пользователю с идентификатором `userId` отредактировать 
  комментарий с идентификатором `comId`. Данные для обновления комментария передаются в теле запроса.
  - `DELETE /users/{userId}/comments/{comId}` -позволяет пользователю с идентификатором `userId` удалить (пометить как 
  `DELETED`) свой комментарий с комментарием `comId`.
  - `GET /users/{userId}/comments` - позволяют пользователю с идентификатором `userId` получить все свои комментарии, 
  за исключением тех, что помечены как `DELETED`. В этом запросе может быть два параметра:
    - `from` - количество комментариев, которые нужно пропустить при создании данного списка комментариев. Значение
      по-умолчанию - 0.
    - `size` - количество комментариев, которые нужно вернуть. Значение по-умолчанию - 10.
  - `GET /users/{userId}/comments/{comId}` - позволяет пользователю с идентификатором `userId` получить свой комментарий 
  с идентификатором `comId`. Пользователь может получить комментарий с любым статусом кроме `DELETED`. 